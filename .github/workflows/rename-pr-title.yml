on:
  pull_request:
    types: [opened, edited]

permissions:
  pull-requests: read
  pull-requests: write

name: Rewrite and Validate PR Title
description: |
  This GitHub Action will rewrite the PR title if it is in the slash format
  (e.g., feat/new stuff or chore(main)/new stuff), which is commonly set by GitHub during pull request creation,
  and validate that the title is in the conventional commit format (e.g., 'feat: description').
  If the title is not in the conventional commit format, the action will fail.

jobs:
  rewrite-pr-title:
    runs-on: ubuntu-latest
    steps:
      - name: Rewrite PR Title from slash format
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info("No pull request payload found, skipping.");
              return;
            }

            let title = pr.title;
            core.info(`Original PR title: ${title}`);

            // Regex to detect slash format: type(scope)/description or type/description
            // Examples: feat(auth)/new feature, chore/main/fix, fix/bug description
            const slashRegex = /^(feat|fix|chore|docs|style|refactor|perf|test|build|ci|revert)(?:\([^)]+\))?\/(.+)$/i;
            const match = title.match(slashRegex);

            if (match) {
              const type = match[1].toLowerCase();
              const description = match[2].trim();
              const scopeMatch = title.match(/^[^(]+\(([^)]+)\)/);
              const scope = scopeMatch ? scopeMatch[1] : null;
              
              // Preserve scope if it exists, otherwise use simple format
              const newTitle = scope 
                ? `${type}(${scope}): ${description}`
                : `${type}: ${description}`;

              if (newTitle !== title) {
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  title: newTitle,
                });
                core.info(`PR title updated from "${title}" to "${newTitle}"`);
              }
            } else {
              core.info("PR title is not in slash format, skipping rewrite.");
            }

      - name: Validate PR Title Format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            chore
            docs
            style
            refactor
            perf
            test
            build
            ci
            revert
          scopes: |
            optional
          requireScope: false
          subjectPattern: ^.+$
          subjectPatternError: |
            The subject "{subject}" found in the PR title "{title}" didn't match the configured pattern. Please ensure it follows the conventional commit format.
          wip: true
          validateSingleCommit: false
