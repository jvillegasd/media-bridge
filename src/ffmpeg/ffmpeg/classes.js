import{FFMessageType}from"./const.js";import{getMessageID}from"./utils.js";import{ERROR_TERMINATED,ERROR_NOT_LOADED}from"./errors.js";export class FFmpeg{#e=null;#s={};#t={};#a=[];#r=[];loaded=!1;#i=()=>{this.#e&&(this.#e.onmessage=({data:{id:e,type:s,data:t}})=>{switch(s){case FFMessageType.LOAD:this.loaded=!0,this.#s[e](t);break;case FFMessageType.MOUNT:case FFMessageType.UNMOUNT:case FFMessageType.EXEC:case FFMessageType.FFPROBE:case FFMessageType.WRITE_FILE:case FFMessageType.READ_FILE:case FFMessageType.DELETE_FILE:case FFMessageType.RENAME:case FFMessageType.CREATE_DIR:case FFMessageType.LIST_DIR:case FFMessageType.DELETE_DIR:this.#s[e](t);break;case FFMessageType.LOG:this.#a.forEach(e=>e(t));break;case FFMessageType.PROGRESS:this.#r.forEach(e=>e(t));break;case FFMessageType.ERROR:this.#t[e](t)}delete this.#s[e],delete this.#t[e]})};#o=({type:e,data:s},t=[],a)=>this.#e?new Promise((r,i)=>{const o=getMessageID();this.#e&&this.#e.postMessage({id:o,type:e,data:s},t),this.#s[o]=r,this.#t[o]=i,a?.addEventListener("abort",()=>{i(new DOMException(`Message # ${o} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(ERROR_NOT_LOADED);on(e,s){"log"===e?this.#a.push(s):"progress"===e&&this.#r.push(s)}off(e,s){"log"===e?this.#a=this.#a.filter(e=>e!==s):"progress"===e&&(this.#r=this.#r.filter(e=>e!==s))}load=({classWorkerURL:e,...s}={},{signal:t}={})=>(this.#e||(this.#e=e?new Worker(new URL(e,import.meta.url),{type:"module"}):new Worker(new URL("./worker.js",import.meta.url),{type:"module"}),this.#i()),this.#o({type:FFMessageType.LOAD,data:s},void 0,t));exec=(e,s=-1,{signal:t}={})=>this.#o({type:FFMessageType.EXEC,data:{args:e,timeout:s}},void 0,t);ffprobe=(e,s=-1,{signal:t}={})=>this.#o({type:FFMessageType.FFPROBE,data:{args:e,timeout:s}},void 0,t);terminate=()=>{const e=Object.keys(this.#t);for(const s of e)this.#t[s](ERROR_TERMINATED),delete this.#t[s],delete this.#s[s];this.#e&&(this.#e.terminate(),this.#e=null,this.loaded=!1)};writeFile=(e,s,{signal:t}={})=>{const a=[];return s instanceof Uint8Array&&a.push(s.buffer),this.#o({type:FFMessageType.WRITE_FILE,data:{path:e,data:s}},a,t)};mount=(e,s,t)=>this.#o({type:FFMessageType.MOUNT,data:{fsType:e,options:s,mountPoint:t}},[]);unmount=e=>this.#o({type:FFMessageType.UNMOUNT,data:{mountPoint:e}},[]);readFile=(e,s="binary",{signal:t}={})=>this.#o({type:FFMessageType.READ_FILE,data:{path:e,encoding:s}},void 0,t);deleteFile=(e,{signal:s}={})=>this.#o({type:FFMessageType.DELETE_FILE,data:{path:e}},void 0,s);rename=(e,s,{signal:t}={})=>this.#o({type:FFMessageType.RENAME,data:{oldPath:e,newPath:s}},void 0,t);createDir=(e,{signal:s}={})=>this.#o({type:FFMessageType.CREATE_DIR,data:{path:e}},void 0,s);listDir=(e,{signal:s}={})=>this.#o({type:FFMessageType.LIST_DIR,data:{path:e}},void 0,s);deleteDir=(e,{signal:s}={})=>this.#o({type:FFMessageType.DELETE_DIR,data:{path:e}},void 0,s)}