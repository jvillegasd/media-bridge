import{CORE_URL,FFMessageType}from"./const.js";import{ERROR_UNKNOWN_MESSAGE_TYPE,ERROR_NOT_LOADED,ERROR_IMPORT_FAILURE}from"./errors.js";let ffmpeg;const load=async({coreURL:e,wasmURL:s,workerURL:t})=>{const a=!ffmpeg;try{e||(e=CORE_URL),importScripts(e)}catch{if(e&&e!==CORE_URL||(e=CORE_URL.replace("/umd/","/esm/")),self.createFFmpegCore=(await import(e)).default,!self.createFFmpegCore)throw ERROR_IMPORT_FAILURE}const r=e,f=s||e.replace(/.js$/g,".wasm"),p=t||e.replace(/.js$/g,".worker.js");return ffmpeg=await self.createFFmpegCore({mainScriptUrlOrBlob:`${r}#${btoa(JSON.stringify({wasmURL:f,workerURL:p}))}`}),ffmpeg.setLogger(e=>self.postMessage({type:FFMessageType.LOG,data:e})),ffmpeg.setProgress(e=>self.postMessage({type:FFMessageType.PROGRESS,data:e})),a},exec=({args:e,timeout:s=-1})=>{ffmpeg.setTimeout(s),ffmpeg.exec(...e);const t=ffmpeg.ret;return ffmpeg.reset(),t},ffprobe=({args:e,timeout:s=-1})=>{ffmpeg.setTimeout(s),ffmpeg.ffprobe(...e);const t=ffmpeg.ret;return ffmpeg.reset(),t},writeFile=({path:e,data:s})=>(ffmpeg.FS.writeFile(e,s),!0),readFile=({path:e,encoding:s})=>ffmpeg.FS.readFile(e,{encoding:s}),deleteFile=({path:e})=>(ffmpeg.FS.unlink(e),!0),rename=({oldPath:e,newPath:s})=>(ffmpeg.FS.rename(e,s),!0),createDir=({path:e})=>(ffmpeg.FS.mkdir(e),!0),listDir=({path:e})=>{const s=ffmpeg.FS.readdir(e),t=[];for(const a of s){const s=ffmpeg.FS.stat(`${e}/${a}`),r=ffmpeg.FS.isDir(s.mode);t.push({name:a,isDir:r})}return t},deleteDir=({path:e})=>(ffmpeg.FS.rmdir(e),!0),mount=({fsType:e,options:s,mountPoint:t})=>{const a=e,r=ffmpeg.FS.filesystems[a];return!!r&&(ffmpeg.FS.mount(r,s,t),!0)},unmount=({mountPoint:e})=>(ffmpeg.FS.unmount(e),!0);self.onmessage=async({data:{id:e,type:s,data:t}})=>{const a=[];let r;try{if(s!==FFMessageType.LOAD&&!ffmpeg)throw ERROR_NOT_LOADED;switch(s){case FFMessageType.LOAD:r=await load(t);break;case FFMessageType.EXEC:r=exec(t);break;case FFMessageType.FFPROBE:r=ffprobe(t);break;case FFMessageType.WRITE_FILE:r=writeFile(t);break;case FFMessageType.READ_FILE:r=readFile(t);break;case FFMessageType.DELETE_FILE:r=deleteFile(t);break;case FFMessageType.RENAME:r=rename(t);break;case FFMessageType.CREATE_DIR:r=createDir(t);break;case FFMessageType.LIST_DIR:r=listDir(t);break;case FFMessageType.DELETE_DIR:r=deleteDir(t);break;case FFMessageType.MOUNT:r=mount(t);break;case FFMessageType.UNMOUNT:r=unmount(t);break;default:throw ERROR_UNKNOWN_MESSAGE_TYPE}}catch(s){return void self.postMessage({id:e,type:FFMessageType.ERROR,data:s.toString()})}r instanceof Uint8Array&&a.push(r.buffer),self.postMessage({id:e,type:s,data:r},a)};