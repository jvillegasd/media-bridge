import{ERROR_RESPONSE_BODY_READER,ERROR_INCOMPLETED_DOWNLOAD}from"./errors.js";import{HeaderContentLength}from"./const.js";const readFromBlobOrFile=e=>new Promise((t,r)=>{const a=new FileReader;a.onload=()=>{const{result:e}=a;e instanceof ArrayBuffer?t(new Uint8Array(e)):t(new Uint8Array)},a.onerror=e=>{r(Error(`File could not be read! Code=${e?.target?.error?.code||-1}`))},a.readAsArrayBuffer(e)});export const fetchFile=async e=>{let t;if("string"==typeof e)t=/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(e)?atob(e.split(",")[1]).split("").map(e=>e.charCodeAt(0)):await(await fetch(e)).arrayBuffer();else if(e instanceof URL)t=await(await fetch(e)).arrayBuffer();else{if(!(e instanceof File||e instanceof Blob))return new Uint8Array;t=await readFromBlobOrFile(e)}return new Uint8Array(t)};export const importScript=async e=>new Promise(t=>{const r=document.createElement("script"),a=()=>{r.removeEventListener("load",a),t()};r.src=e,r.type="text/javascript",r.addEventListener("load",a),document.getElementsByTagName("head")[0].appendChild(r)});export const downloadWithProgress=async(e,t)=>{const r=await fetch(e);let a;try{const o=parseInt(r.headers.get(HeaderContentLength)||"-1"),n=r.body?.getReader();if(!n)throw ERROR_RESPONSE_BODY_READER;const s=[];let i=0;for(;;){const{done:r,value:a}=await n.read(),c=a?a.length:0;if(r){if(-1!=o&&o!==i)throw ERROR_INCOMPLETED_DOWNLOAD;t&&t({url:e,total:o,received:i,delta:c,done:r});break}s.push(a),i+=c,t&&t({url:e,total:o,received:i,delta:c,done:r})}const c=new Uint8Array(i);let d=0;for(const e of s)c.set(e,d),d+=e.length;a=c.buffer}catch(o){console.log("failed to send download progress event: ",o),a=await r.arrayBuffer(),t&&t({url:e,total:a.byteLength,received:a.byteLength,delta:0,done:!0})}return a};export const toBlobURL=async(e,t,r=!1,a)=>{const o=r?await downloadWithProgress(e,a):await(await fetch(e)).arrayBuffer(),n=new Blob([o],{type:t});return URL.createObjectURL(n)};